generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Country {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  states    State[]
}

model State {
  id        String   @id @default(cuid())
  countryId String
  name      String
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  country   Country  @relation(fields: [countryId], references: [id])
  cities    City[]

  @@index([countryId])
}

model City {
  id        String   @id @default(cuid())
  stateId   String
  name      String
  type      String   // municipal_corp, mahanagar_palika
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  state     State    @relation(fields: [stateId], references: [id])
  wards     Ward[]

  @@index([stateId])
}

model Ward {
  id             String          @id @default(cuid())
  cityId         String
  wardNumber     Int
  name           String
  boundaryGeoJson String?
  population     Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  city           City            @relation(fields: [cityId], references: [id])
  representatives Representative[]
  users          User[]
  issues         Issue[]

  @@unique([cityId, wardNumber])
  @@index([cityId])
}

model Party {
  id             String          @id @default(cuid())
  name           String
  abbreviation   String          @unique
  symbol         String?
  color          String?
  foundedDate    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  representatives Representative[]
}

model User {
  id        String   @id @default(cuid())
  phone     String   @unique
  name      String?
  email     String?  @unique
  role      String   @default("citizen") // citizen, representative, party_admin, super_admin
  wardId    String?
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ward      Ward?    @relation(fields: [wardId], references: [id])
  representative Representative?
  issues    Issue[]
  issueUpvotes IssueUpvote[]

  @@index([wardId])
  @@index([phone])
}

model Representative {
  id          String             @id @default(cuid())
  userId      String             @unique
  partyId     String
  wardId      String
  position    String             // corporator, mla, mp
  verified    Boolean            @default(false)
  termStart   DateTime?
  termEnd     DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  user        User               @relation(fields: [userId], references: [id])
  party       Party              @relation(fields: [partyId], references: [id])
  ward        Ward               @relation(fields: [wardId], references: [id])
  socialProfiles SocialProfile[]
  issueResponses IssueResponse[]

  @@index([partyId])
  @@index([wardId])
}

model SocialProfile {
  id               String         @id @default(cuid())
  representativeId String
  platform         String         // instagram, facebook, twitter
  handle           String
  followers        Int?
  verified         Boolean        @default(false)
  lastSynced       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  representative   Representative @relation(fields: [representativeId], references: [id])

  @@unique([representativeId, platform])
  @@index([representativeId])
}

model Issue {
  id          String          @id @default(cuid())
  userId      String
  wardId      String
  title       String
  description String
  category    String          // roads, water, electricity, sanitation, etc.
  status      String          @default("pending") // pending, acknowledged, in_progress, resolved, rejected
  mediaUrls   String          // SQLite doesn't support string arrays, storing as JSON string or CSV
  upvotes     Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation(fields: [userId], references: [id])
  ward        Ward            @relation(fields: [wardId], references: [id])
  responses   IssueResponse[]
  issueUpvotes IssueUpvote[]

  @@index([wardId])
  @@index([userId])
  @@index([status])
  @@index([category])
}

model IssueResponse {
  id               String         @id @default(cuid())
  issueId          String
  representativeId String
  responseText     String
  statusUpdate     String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  issue            Issue          @relation(fields: [issueId], references: [id])
  representative   Representative @relation(fields: [representativeId], references: [id])

  @@index([issueId])
  @@index([representativeId])
}

model IssueUpvote {
  id        String   @id @default(cuid())
  issueId   String
  userId    String
  createdAt DateTime @default(now())
  issue     Issue    @relation(fields: [issueId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([issueId, userId])
  @@index([issueId])
  @@index([userId])
}
